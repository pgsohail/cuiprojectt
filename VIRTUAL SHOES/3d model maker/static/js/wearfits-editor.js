!function(e){"use strict";e.mouseMoveThreshold=10,e.enableSelect=!0,e.loadTileMaterials=!0,e.advanceLevel=1,e.enableUndoHistory=!0,e.transformWholeObject=!0,e.init_ui=!0,e.mementos=[],e.onInitCallback=function(){};let t,a,i=new THREE.Raycaster,n=new THREE.Vector2,r=new THREE.Vector2,o={},s=document.createElement("div"),l=!1,d="MATERIALS",c={},f=0,m=0,p=!1,u=null,_=null,w={},g=new THREE.Vector2,h=!1,y=["brightness","whiteBalance","contrast","saturation","vibrance","exposure","hue","gamma","noise","sharpen","stackBlur"],v=!1;wearfits.modules.editor=!0,wearfits.showResetCameraButton=!0,wearfits.showPresetLabels=!0,wearfits.showOutline=!0,wearfits.modules.fitting_room||(console.log("Wearfits editor: Enabled remove duplicated vertices on load"),wearfits.removeDoublesOnLoad=!0),e.editTools=new THREE.Group,e.editTools.name="EDIT_TOOLS";let b=new THREE.GridHelper(100,100);b.material.color.setRGB(1,0,0),b.name="GRID_1M",b.renderOrder=2,e.editTools.add(b);let E=new THREE.GridHelper(100,1e3);E.material.color.setRGB(1,1,1),E.name="GRID_1DM",E.renderOrder=1,e.editTools.add(E);let T=new THREE.PointsMaterial({size:12,map:function(e,t){var a=document.createElement("canvas");a.width=a.height=t;var i=a.getContext("2d"),n=new THREE.Texture(a),r=t/2;return i.beginPath(),i.arc(r,r,t/2,0,2*Math.PI,!1),i.closePath(),i.fillStyle=e,i.fill(),n.needsUpdate=!0,n}("#000000",256),transparent:!0,sizeAttenuation:!1,depthTest:!1}),M=new THREE.BufferGeometry;M.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0],3));let x=new THREE.Points(M,T);x.name="MEASUREMENT_POINT_1",e.editTools.add(x),e.editTools.measurementPoint1=x;let I=new THREE.BufferGeometry;I.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0],3));let S=new THREE.Points(I,T);S.name="MEASUREMENT_POINT_2",e.editTools.add(S),e.editTools.measurementPoint2=S,wearfits.addEventListener("scene_init",function(t){e.tranformTool.addEventListener("dragging-changed",function(t){e.updateInput()}),setTimeout(()=>{h=!0},1e3)}),wearfits.addEventListener("object_load",function(e){wearfits.selected={},H(e)}),wearfits.addEventListener("object_remove",function(t){e.tranformTool.detach()}),wearfits.addEventListener("texture_load",function(){e.updateInput()}),wearfits.addEventListener("env_map_load",function(){e.updateInput()}),wearfits.addEventListener("material_set_load",function(t,a){e.caman&&Y(),H(t),e.updateInput()}),wearfits.addEventListener("before_material_modified",function(t,a){e.saveMemento()}),wearfits.addEventListener("canvas_create",function(e){R()});let L=document.currentScript.src.split(".").slice(0,-1).join(".")+".html",A=wearfits.request(L,"GET").then(e=>{(a=document.createElement("div")).id="wf_editor_ui",a.innerHTML=e}),k=(new Promise(function(e,t){const a=document.createElement("script");a.src=wearfits.origin+"/static/js/caman.full.js",a.onload=e,wearfits.canvas_container_inner.appendChild(a)}),new Promise(function(e,t){const a=document.createElement("script");a.src=wearfits.origin+"/static/js/color-picker.js",a.onload=e,wearfits.canvas_container_inner.appendChild(a)}));var j=document.createElement("link");function R(){e.tranformTool&&e.editTools.remove(e.tranformTool),wearfits.canvas&&(e.tranformTool=new THREE.TransformControls(wearfits.camera,wearfits.canvas),e.tranformTool.addEventListener("dragging-changed",function(e){wearfits.controls.enabled=!e.value}),e.tranformTool.enabled=!1,e.editTools.add(e.tranformTool))}function C(t=d){d=t,wearfits.scene.remove(e.editTools),e.tranformTool.detach(),s.style.display="block";for(let e of document.getElementsByClassName("wf_editor_category"))e.style.display=e.getAttribute("category")===d?"block":"none";for(let e of document.getElementsByClassName("wf_editor_category_button"))e.style.backgroundColor=e.getAttribute("category")===d?"rgb(200, 200, 200)":"";switch(d){case"MATERIALS":break;case"MESH":wearfits.scene.add(e.editTools),e.tranformTool.enabled&&e.tranformTool.attach(wearfits.selected.mesh);break;case"PRESETS":case"SCENE":s.style.display="none"}e.updateInput()}async function H(t){const a=t.storeBlobTexturePromises||[];await Promise.all(a);for(let e of wearfits.getAllTextures())void 0===e.hasAlphaPixels&&wearfits.setAlphaFlag(e);e.updateInput()}function B(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16)/255,g:parseInt(t[2],16)/255,b:parseInt(t[3],16)/255}:null}function P(e){var t=(e=Math.min(255,Math.round(255*e))).toString(16);return 1==t.length?"0"+t:t}function O(e){let t=e.r,a=e.g,i=e.b;return void 0!==e.x&&(t=e.x,a=e.y,i=e.z),"#"+P(t)+P(a)+P(i)}function N(e){return"string"!=typeof(t=e)||isNaN(t)||isNaN(parseFloat(t))?e:parseFloat(e);var t}function F(e){var t=new Date(e),a=t.getMonth()+1,i=t.getDate(),n=t.getHours(),r=t.getMinutes(),o=t.getSeconds();return a=(a<10?"0":"")+a,i=(i<10?"0":"")+i,n=(n<10?"0":"")+n,r=(r<10?"0":"")+r,o=(o<10?"0":"")+o,t.getFullYear()+"-"+a+"-"+i+" "+n+":"+r+":"+o}function U(e,t,a){for(let i of a){let a=window[e+i],n=window[e+i+"_slider"],r=t[i];a&&void 0!==r&&null!==r&&(r.isColor&&(r=O(r)),"checkbox"===a.type?a.checked=r:a.value=r,a.classList.contains("hex_color_input")&&(a.style.backgroundColor=r)),n&&(n.value=r)}}function D(e,t,a,i,n,r){let o=document.createElement("input");return o.type="submit",o.value=r,o.onclick=async function(){await async function(e,t,a,i,n){let r=await wearfits.resizeImage(e,t,a,i);for(const[e,t]of n)wearfits.loadTexturesToSelectedMaterial([r],t,[e],!0)}(e,t,a,n,i),wf_editor.updateInput()},o}function z(e,t){let a=document.createElement("input");return a.type="submit",a.value=t,a.onclick=async function(){await async function(e){for(const[t,a]of e){const e=t[a].solidColor;e&&(await wearfits.loadTexture(t,a,""),"map"===a&&(console.log(t.name+" set color:"+e.toArray()),t.color.multiply(e)),"metalnessMap"===a&&(console.log(t.name+" set metalness:"+e.b),t.metalness*=e.b),"roughnessMap"===a&&(console.log(t.name+" set roughness:"+e.g),t.roughness*=e.g))}}(e),wf_editor.updateInput()},a}function W(e=4096){const t={};for(let a of wearfits.getAllMaterials())for(let i of wearfits.definedMaps){let n=a[i];if(n&&n.image){let r=n.image,o=wearfits.getMapFilename(n);if(t[o]){t[o].materials.push([a,i]);continue}let s=r.naturalWidth||r.width,l=r.naturalHeight||r.height;const d={type:"texture",issues:[],filename:o,image:r,sizeX:s,sizeY:l,materials:[[a,i]]};t[o]=d,(s>=e||l>=e)&&d.issues.push("oversized"),"map"===i?o.endsWith(".jpg")||o.endsWith(".jpeg")||n.hasAlphaPixels||d.issues.push("png"):o.endsWith(".jpg")||o.endsWith(".jpeg")||d.issues.push("png"),n.solidColor&&d.issues.push("solid_color")}}const a=Object.values(t).filter(e=>e.issues.length),i=wearfits.getSceneTriangles();return i>15e4&&a.push({type:"info",values:["Scene too complex.","Triangles count: "+i]}),a}function X(){let e=document.getElementById("wf_editor_measurement_container");if(!wearfits.custom_popup_content.contains(e)){const e=document.getElementById("wf_editor_measurement_container_template").content.cloneNode(!0);wearfits.custom_popup_content.innerHTML="",wearfits.custom_popup_content.appendChild(e)}wearfits.custom_popup_content.style.display="flex",wearfits.custom_popup_content.style["align-content"]="center",wearfits.custom_popup_content.style["justify-content"]="center";const t=wearfits.selected.object,a=wearfits.garmentProp[t.name],i=t.properties.custom;let n=["height","chest","waist","hips","shoulders","thigh","calf","upperarm","uvMapRealLength"],r=a.sizes;const o=document.getElementById("wf_editor_measurement_sizes");o.innerHTML="";for(let e of r){let t=document.createElement("tr");o.appendChild(t);let a=document.createElement("td");t.appendChild(a),a.innerHTML=e;for(let a of n){const i='<input type="number" id="wf_editor_input_custom_measurement_'+e+"_"+a+'" title="'+a+" "+e+'" oninput="wf_editor.updateAttribute(this)"  value="" step="'+("uvMapRealLength"===a?.01:.5)+'" style="width:80px">';let n=document.createElement("td");n.innerHTML=i,t.appendChild(n)}}let s=document.createElement("tr");o.appendChild(s);let l=document.createElement("td");s.appendChild(l),l.innerHTML="";for(let e of n){const t='<button measurement-prop="'+e+'" onclick="wf_editor.fill_measurement_columns(this)" style="width:80px">Fill</button>';let a=document.createElement("td");a.innerHTML=t,s.appendChild(a)}if(i.measurement)for(let e in i.measurement)for(let t of n){let a=i.measurement[e][t],n=window["wf_editor_input_custom_measurement_"+e+"_"+t];a&&n&&(n.value=a)}}function Y(){delete e.caman,delete e.edit_canvas,delete e.edit_texture_canvas,delete e.edit_texture_context,delete e.edit_original_texture,delete e.edit_texture,delete e.edit_material,delete e.edit_matType,window.wf_editor_image_mode_button.style.display="","IMAGE"===d&&C("MATERIALS")}async function G(e,t=(e=>{s.innerHTML=e})){t("Upload materials pending");try{await wearfits.request(wearfits.origin+"/api/set_materials","POST",e),t("Upload material data OK")}catch(e){throw t("Upload materials error: "+e.response),"Upload materials error: "+e.response}}async function K(e,t=(e=>{s.innerHTML=e})){t("Upload materials pending");try{await wearfits.request(wearfits.origin+"/api/set_tile_material","POST",e),t("Upload material data OK")}catch(e){throw t("Upload materials error: "+e.response),"Upload materials error: "+e.response}}async function V(e){const t=await wearfits.readFile(e),a=pako.gzip(t),i=function(e){for(var t=[],a=0;a<e.length;a+=32768)t.push(String.fromCharCode.apply(null,e.subarray(a,a+32768)));return t.join("")}(a),n=wearfits.MD5(i);console.log(n);const r=e.name.split(".").pop();return new File([a],n+"."+r+".gz")}function q(e){let t=new FormData;if(t.append("sessionID",wearfits.sessionID),document.getElementById("wf_editor_remove_thickness").checked&&t.append("remove_thickness",1),t.append("texture_size",document.getElementById("wf_editor_bake_texture_size").value),t.append("scene",document.getElementById("wf_editor_bake_scene").value),e&&t.append("ao_only",1),wearfits.modules.fitting_room)t.append("hash",wearfits.garment.hash),t.append("garment",wearfits.garment.id),t.append("preset",wearfits.garment.preset);else if(t.append("name",wearfits.getSceneName()),document.getElementById("wf_editor_bake_selected_only").checked){let e="";for(let t of wearfits.selected.materials)e+=t.name+",";t.append("selected_materials",e)}wearfits.request(wearfits.origin+"/api/bake","POST",t).then(()=>{s.innerHTML="TASK REGISTERED!"}).catch(e=>{401==e.status?s.innerHTML="BAKE UNAUTHORIZED!":s.innerHTML="BAKE FAILED!"})}function J(t){if(t)return window.wf_editor_tile_material_name&&(window.wf_editor_tile_material_name.value=t),wearfits.loadTileMaterial(t,null,wearfits.selected.material.name).then(()=>{wearfits.setSelectedMaterial(),e.updateInput()});wearfits.selected.material.tile_material_name=""}function Z(){u=null;let t=e.transformWholeObject?wearfits.selected.object.meshes:[wearfits.selected.mesh];for(let e of t){const[t,a,i,n]=w[e.name];e.position.copy(t),e.quaternion.copy(a),e.scale.copy(i),e.updateMatrix()}wearfits.forceRenderWithTimeout(),wf_editor.updateInput(),wearfits.triggerEvent("cancel_translation")}function $(a){a.target===wearfits.canvas&&(l=!0,t=e.mouseMoveThreshold),3!==a.which&&2!==a.button||o.elementX&&(l=!1,o.elementX.value=o.elementStartValueX,o.elementX.oninput?o.elementX.oninput():e.updateAttribute(o.elementX),o.elementY&&(o.elementY.value=o.elementStartValueY,e.updateAttribute(o.elementY)),o.elementX=void 0,o.elementY=void 0,e.updateInput())}function Q(a){u&&function(){const t=e.transformWholeObject?wearfits.selected.object.meshes:[wearfits.selected.mesh];let a=null;for(let e of t){const t=r.x-g.x,i=-(r.y-g.y),[n,o,s,l]=w[e.name];switch(u){case"POSITION":const l=n.clone();if(!a){const e=wearfits.camera.position.clone().sub(l).length(),n=wearfits.camera.fov*(Math.PI/180),r=e*Math.tan(n/2),o=2*t*(r*wearfits.camera.aspect)/wearfits.canvas.clientWidth,s=2*i*r/wearfits.canvas.clientHeight,d=new THREE.Vector3;d.setFromMatrixColumn(wearfits.camera.matrix,0),d.multiplyScalar(o);const c=new THREE.Vector3;c.setFromMatrixColumn(wearfits.camera.matrix,1),c.multiplyScalar(s),a=new THREE.Vector3,"X"===_?a.x=d.x+c.x:"Y"===_?a.y=d.y+c.y:"Z"===_?a.z=d.z+c.z:(a.x=d.x+c.x,a.y=d.y+c.y,a.z=d.z+c.z)}l.x+=a.x,l.y+=a.y,l.z+=a.z,e.position.copy(l);break;case"ROTATION":e.quaternion.copy(o),e.updateMatrixWorld();const d=e.position.clone().applyMatrix4(e.matrixWorld);let c=wearfits.camera.position.clone().sub(d).normalize();const f=wearfits.projectToScreen(d),m=wearfits.canvas.getBoundingClientRect();f.x+=m.left,f.y+=m.top;const p=g.clone().sub(f).normalize(),w=r.clone().sub(f).normalize(),h=Math.atan2(w.x,w.y)-Math.atan2(p.x,p.y),y=new THREE.Vector3(0,0,0).applyMatrix4(e.matrixWorld);if("X"===_){const t=new THREE.Vector3(1,0,0);t.applyMatrix4(e.matrixWorld),c=t.sub(y).normalize()}else if("Y"===_){const t=new THREE.Vector3(0,1,0);t.applyMatrix4(e.matrixWorld),c=t.sub(y).normalize()}else if("Z"===_){const t=new THREE.Vector3(0,0,1);t.applyMatrix4(e.matrixWorld),c=t.sub(y).normalize()}e.rotateOnWorldAxis(c,h);break;case"SCALE":if(e.scale.copy(s),e.position.copy(n),t+i!==0){const a=(t+i)/(Math.abs(t)+Math.abs(i)),n=Math.sqrt(t*t+i*i)*a,r=Math.max(1+2*n/wearfits.canvas.clientWidth,.01);"X"===_?e.scale.x*=r:"Y"===_?e.scale.y*=r:"Z"===_?e.scale.z*=r:(e.scale.multiplyScalar(r),e.position.multiplyScalar(r))}break;default:console.log("Unknow translate type")}e.updateMatrix()}wearfits.forceRenderWithTimeout(),wf_editor.updateInputThrottled(),wearfits.triggerEvent("update_translation")}(),e.tranformTool&&e.tranformTool.enabled&&wearfits.forceRenderWithTimeout("transform_tool");let i=void 0!==a.clientX?a.clientX:a.changedTouches[0].clientX,n=void 0!==a.clientX?a.clientY:a.changedTouches[0].clientY;r.set(i,n),t--||(l=!1),function(t){if(o.elementX){let a=void 0!==t.clientX?t.clientX:t.changedTouches[0].clientX,i=void 0!==t.clientX?t.clientY:t.changedTouches[0].clientY,n=a-o.startX,r=o.startY-i,s=n+r;if(o.elementY){let e=o.elementStartValueX+Math.sign(n)*n*n/1e4,t=o.elementStartValueY+Math.sign(r)*r*r/1e4;o.elementX.value=ae(e,o.minX,o.maxX),o.elementX.oninput(),o.elementY.value=ae(t,o.minY,o.maxY),o.elementY.oninput()}else{let e=o.elementStartValueX+Math.sign(s)*s*s/1e4;o.elementX.value=ae(e,o.minX,o.maxX),o.elementX.oninput()}e.updateInput()}}(a)}function ee(t){if(o.elementX=void 0,o.elementY=void 0,u)return t.preventDefault(),void(3===t.which||2===t.button?Z():(u=null,wearfits.forceRenderWithTimeout(),wearfits.triggerEvent("finished_translation")));if(!e.enableSelect||!l)return;l=!1,t.preventDefault();let a=[];for(let e of wearfits.objects)if(e&&!e.disableSelect&&e.meshes&&e.meshes.length)for(let t of e.meshes)a.push(t);let r=!1;if(a.length){let o=void 0!==t.clientX?t.clientX:t.changedTouches[0].clientX,s=void 0!==t.clientX?t.clientY:t.changedTouches[0].clientY,l=wearfits.canvas.getBoundingClientRect();n.x=(o-l.left)/wearfits.canvas.offsetWidth*2-1,n.y=-(s-l.top)/wearfits.canvas.offsetHeight*2+1,i.setFromCamera(n,wearfits.camera);let c=i.intersectObjects(a);for(let a of c){let i=a.face.materialIndex,n=a.object,o=n.material;if(Array.isArray(n.material)&&(o=n.material[i]),o.visible){if(wearfits.selected.mesh=n,wearfits.selected.materialIndex=i,wearfits.selected.material=o,wearfits.selected.object=n.object,t.shiftKey?(wearfits.selected.materials||(wearfits.selected.materials=[]),wearfits.selected.materials.includes(o)?wearfits.selected.materials=wearfits.selected.materials.filter(e=>e!=o):wearfits.selected.materials.push(o)):wearfits.selected.materials=[o],e.tranformTool.enabled&&e.tranformTool.attach(wearfits.selected.mesh),"MESH"===d){(t.shiftKey?e.editTools.measurementPoint2:e.editTools.measurementPoint1).position.copy(a.point)}r=!0;break}}}r||(wearfits.selected={}),e.updateInput()}function te(e,t,a){if(3===a.which||2===a.button)return;o.startX=void 0!==a.clientX?a.clientX:a.changedTouches[0].clientX,o.startY=void 0!==a.clientX?a.clientY:a.changedTouches[0].clientY,o.elementX=e,o.elementStartValueX=parseFloat(e.value);let i=parseFloat(e.getAttribute("min")),n=parseFloat(e.getAttribute("max"));if(o.minX=isFinite(i)?i:-1/0,o.maxX=isFinite(n)?n:1/0,t){o.elementY=t,o.elementStartValueY=parseFloat(t.value);let a=parseFloat(e.getAttribute("min")),i=parseFloat(e.getAttribute("max"));o.minY=isFinite(a)?a:-1/0,o.maxY=isFinite(i)?i:1/0}}function ae(e,t,a){return Math.min(Math.max(e,t),a)}function ie(e,t){t.preventDefault();let a=t.dataTransfer.getData("text/html");if(a){let t=document.createElement("div");t.innerHTML=a;let i=[];for(let e of t.getElementsByTagName("img"))e.src&&i.push(e.src.replace(/%20/g," "));wearfits.loadTexturesToSelectedMaterial(i,e)}else wearfits.loadTexturesToSelectedMaterial(t.dataTransfer.files,e)}function ne(){A.then(()=>{if(!e.init_ui)return;e.initUI(),document.getElementById("wf_editor_upload_all_materials_button").addEventListener("click",()=>{let t=document.getElementById("wf_editor_input_preset").value||"default",a=document.getElementById("wf_editor_upload_preview_image").checked;e.uploadAllMaterialsAtServer(wearfits.selected.object,t,!0,a)},!1),document.getElementById("wf_editor_remove_all_materials_button").addEventListener("click",()=>{let t=document.getElementById("wf_editor_input_preset").value||"default";confirm("Remove material set: "+t+"?")&&e.removeAllMaterialsAtServer(t)},!1),document.getElementById("wf_editor_upload_tile_material_button").addEventListener("click",()=>{let t=document.getElementById("wf_editor_tile_material_name").value;e.uploadTileMaterialAtServer(t)},!1),document.getElementById("wf_editor_remove_tile_material_button").addEventListener("click",()=>{let t=document.getElementById("wf_editor_tile_material_name").value;confirm("Remove material set: "+t+"?")&&e.removeTileMaterialAtServer(t)},!1),e.advanceLevel>=1&&(window.wf_editor_materials_mode_button.style.display="inline-block",window.wf_editor_mesh_mode_button.style.display="inline-block",window.wf_editor_warnings_mode_button.style.display="inline-block"),e.advanceLevel>=3&&(window.wf_editor_tools_mode_button.style.display="inline-block",window.wf_editor_presets_mode_button.style.display="inline-block",window.wf_editor_fr_mode_button.style.display="none",window.wf_editor_camera_mode_button.style.display="inline-block",window.wf_editor_scene_mode_button.style.display="inline-block",window.wf_editor_ar_mode_button.style.display="inline-block",wearfits.modules.fitting_room&&(window.wf_editor_fr_mode_button.style.display="inline-block")),e.advanceLevel>=5&&(window.wf_editor_go_to_admin_button.style.display="inline-block");for(let t of document.getElementsByClassName("map-image")){let a=t.id.split("_").pop();t.addEventListener("mouseenter",e=>{t.title=t.naturalWidth+" x "+t.naturalHeight}),t.addEventListener("click",t=>{let i=document.createElement("input");i.type="file",i.onchange=(()=>{e.saveMemento(),wearfits.loadTexturesToSelectedMaterial(i.files,a)}),i.click()}),t.addEventListener("dragover",e=>{e.preventDefault(),t.style.backgroundColor="green"}),t.addEventListener("drop",e=>{ie(a,e)})}for(let e of document.getElementsByClassName("clickable_label")){let t=e.id.split("_").pop();e.addEventListener("dragover",t=>{t.preventDefault(),e.style.backgroundColor="green"}),e.addEventListener("drop",e=>{ie(t,e)})}if(wearfits.canvas_container.addEventListener("dragenter",e=>{for(let e of document.querySelectorAll(".clickable_label,.map-image"))e.style.backgroundColor="blue"}),wearfits.canvas_container.addEventListener("dragleave",e=>{for(let e of document.querySelectorAll(".clickable_label,.map-image"))e.style.backgroundColor="rgba(0, 0, 0, 0)"}),wearfits.canvas_container.addEventListener("drop",e=>{for(let e of document.querySelectorAll(".clickable_label,.map-image"))e.style.backgroundColor="rgba(0, 0, 0, 0)"}),e.enableTileMaterialEditor){for(let e of document.getElementsByClassName("tile-material-uploader"))e.style.display="flex";let e=["wf_editor_material_set_upload_line","wf_editor_material_name_line","wf_editor_mesh_mode_button","wf_editor_camera_mode_button","wf_editor_scene_mode_button","wf_editor_tools_mode_button","wf_editor_ar_mode_button","wf_editor_mesh_name_line","wf_editor_object_name_line","wf_editor_preset_line","wf_editor_input_useTileMaterials"];for(let t of e){let e=document.getElementById(t);e&&(e.style.display="none")}}for(let t of document.getElementsByClassName("wf_editor_remove_map_button")){let a=t.getAttribute("mapType");t&&t.addEventListener("click",async i=>{let n=wearfits.selected.material;e.saveMemento(),i.preventDefault(),t.value="";let r=await wearfits.loadTexture(n,a,"");"map"===a&&wearfits.setTransparentAuto(n,r),wearfits.useHybridRenderer||(wearfits.sceneChanged=!0),e.updateInput()},!1)}for(let t of document.getElementsByClassName("wf_editor_edit_map_button")){let a=t.getAttribute("mapType");t.addEventListener("click",async t=>{t.preventDefault();let i=wearfits.selected.material;e.initImageEditor(i,a),wearfits.useHybridRenderer||(wearfits.sceneChanged=!0),e.updateInput()},!1)}window.wf_editor_input_objectname&&(wf_editor_input_objectname.oninput=(()=>{let t=wf_editor_input_objectname.value;for(let e of wearfits.objects)e.name===t&&(wearfits.selected.object=e,wearfits.selected.mesh=e.mesh,wearfits.selected.materialIndex=0,wearfits.selected.material=e.mesh.material[0],wearfits.selected.materials=[e.mesh.material[0]]);e.updateInput()})),window.wf_editor_input_meshname&&(wf_editor_input_meshname.oninput=(()=>{let t=wf_editor_input_meshname.value,a=wearfits.selected.object.meshes;for(let e of a)e.name===t&&(wearfits.selected.mesh=e,wearfits.selected.materialIndex=0,wearfits.selected.material=e.material[0],wearfits.selected.materials=[e.material[0]]);e.updateInput()})),window.wf_editor_input_materialname&&(wf_editor_input_materialname.oninput=(()=>{let t=wf_editor_input_materialname.value;for(let e of wearfits.selected.object.meshes)for(let a=0;a<e.material.length;++a)if(e.material[a].name===t){wearfits.selected.mesh=e,wearfits.selected.materialIndex=a,wearfits.selected.material=e.material[a],wearfits.selected.materials=[e.material[a]];break}e.updateInput()}));const t=document.getElementById("wf_editor_transform_type");t&&(t.onchange=(()=>{e.setTransformTool(t.value)}));for(let t of document.getElementsByClassName("wf_editor_multiple_scale"))t.addEventListener("click",function(){const a=parseFloat(t.value),i=e.transformWholeObject?wearfits.selected.object.meshes:[wearfits.selected.mesh];for(let e of i)e.scale.multiplyScalar(a),e.position.multiplyScalar(a);wearfits.resetCameraPosition(!1),wf_editor.updateInput()},!1);if(document.getElementById("wf_editor_set_scale_from_points").addEventListener("click",()=>{let t=e.editTools.measurementPoint1.position.distanceTo(e.editTools.measurementPoint2.position),a=parseFloat(wf_editor_real_points_distance.value);if(!t)return void wearfits.showToast("Points distance is zero!");let i=a/t;e.editTools.measurementPoint1.position.multiplyScalar(i),e.editTools.measurementPoint2.position.multiplyScalar(i),wf_editor_input_mesh_scale.value*=i,wf_editor_input_mesh_scale.oninput(),wearfits.resetCameraPosition(!1)},!1),window.wf_editor_input_scene_theme)for(let e in wearfits.themes){let t=document.createElement("option");t.text=e,t.value=e,window.wf_editor_input_scene_theme.appendChild(t)}if(window.wf_editor_env_map_select){wf_editor_env_map_select.oninput=(()=>{const e=wf_editor_env_map_select.value,t=wearfits.envMapUrlList[e];wearfits.envMapUrl=t});for(let e in wearfits.envMapUrlList){let t=document.createElement("option");t.text=e,t.value=e,window.wf_editor_env_map_select.appendChild(t)}}e.loadTileMaterials&&wearfits.request(wearfits.origin+"/api/get_tile_materials","GET").then(e=>{let t=JSON.parse(e),a=document.getElementById("wf_editor_preset_list");if(a){for(let e of t){let t=e.name,i=document.createElement("option");i.text=t,i.value=t,a.appendChild(i)}a.oninput=(()=>{let e=a.options[a.selectedIndex].value;a.value="",J(e)})}let i=document.getElementById("wf_editor_presets");if(i)for(let e of t){let t=document.createElement("div");t.style.display="inline-block",t.style.margin="1px",t.style.cursor="pointer",t.setAttribute("tile_material_name",e.name),t.onclick=J.bind(null,e.name);let a=document.createElement("img");a.classList.add("wf-editor-tile-material-image"),a.src="",a.hiddenSrc=e.preview_url,t.appendChild(a),i.appendChild(t)}});for(let t of a.getElementsByTagName("*"))t.id.startsWith("wf_editor_input")&&(t.oninput||t.onchange||(t.oninput=(()=>{let a=t.value;e.updateAttribute(t),e.updateInput(),t.value=a})));for(let e of a.getElementsByClassName("wf_editor_image_filter_slider")){const t="wf_editor_image_filter_slider_",a=e.id.substring(t.length),i=document.getElementById("wf_editor_image_filter_value_"+a);e.oninput=function(){i.value=this.value,i.onchange()}}for(let t of a.getElementsByClassName("wf_editor_image_filter_value"))t.onchange=e.updateImageFilters;for(let t of a.getElementsByClassName("wf_editor_restore_filter_button")){const a=t.parentElement.getAttribute("filter-name");t.onclick=e.resetImageFilter.bind(null,a)}for(let e of document.getElementsByClassName("hex_color_input")){let t=e.onchange||e.oninput;k.then(()=>{new CP(e).on("change",function(e,a,i,n){let r=CP.HEX([e,a,i,1]);this.source.value=r,h&&wearfits.selected.material&&t&&t()})})}for(let e of a.getElementsByClassName("wf_dragable"))e.addEventListener("mousedown",te.bind(null,e,null),{passive:!1}),e.addEventListener("touchstart",te.bind(null,e,null),{passive:!1});let i=document.getElementById("wf_editor_input_offset"),n=document.getElementById("wf_editor_input_uv_offset_x"),r=document.getElementById("wf_editor_input_uv_offset_y");i&&n&&r&&(i.addEventListener("mousedown",te.bind(null,n,r),{passive:!1}),i.addEventListener("touchstart",te.bind(null,n,r),{passive:!1})),wf_editor.onInitCallback(),p=!0,wf_editor.updateInput()}),document.addEventListener("mousedown",$,{passive:!1}),document.addEventListener("mousemove",Q,{passive:!1}),document.addEventListener("mouseup",ee,{passive:!1}),document.addEventListener("touchstart",$,{passive:!1}),document.addEventListener("touchmove",Q,{passive:!1}),document.addEventListener("touchend",ee,{passive:!1}),document.addEventListener("copy",e=>{if(document.activeElement&&"INPUT"===document.activeElement.nodeName&&("number"===document.activeElement.type||"text"===document.activeElement.type))return!0;let t=[wearfits.getMaterialData(wearfits.selected.material)],a=JSON.stringify(t);e.clipboardData.setData("text/plain",a),e.preventDefault(),wearfits.showToast("Copied material: "+wearfits.selected.material.name)}),document.addEventListener("paste",async function(e){if(document.activeElement&&"INPUT"===document.activeElement.nodeName&&("number"===document.activeElement.type||"text"===document.activeElement.type))return!0;let t=(e.clipboardData||window.clipboardData).getData("Text"),a=JSON.parse(t);console.log(a),wearfits.loadSingleMaterial(a),wearfits.showToast("Pasted material: "+a[0].prop.name)}),document.addEventListener("keydown",t=>{if(document.activeElement&&"INPUT"===document.activeElement.nodeName&&("number"===document.activeElement.type||"text"===document.activeElement.type))return!0;if("KeyG"===t.code||"KeyR"===t.code||"KeyS"===t.code){g.copy(r),w={};const a=e.transformWholeObject?wearfits.selected.object.meshes:[wearfits.selected.mesh];for(let e of a)w[e.name]=[e.position.clone(),e.quaternion.clone(),e.scale.clone(),e.matrixWorld.clone()];_=null,"KeyG"===t.code&&(u="POSITION"),"KeyR"===t.code&&(u="ROTATION"),"KeyS"===t.code&&(u="SCALE")}if(u){if("KeyX"===t.code)return void(_="X");if("KeyY"===t.code)return void(_="Y");if("KeyZ"===t.code)return void(_="Z")}if("Escape"===t.code&&Z(),"Delete"===t.code){let t=wearfits.selected.object,a=wearfits.selected.mesh;for(let e=0;e<t.meshes.length;++e)if(a===t.meshes[e]){t.meshes.splice(e,1);break}a.parent.remove(a),wearfits.selected={},e.updateInput()}if("KeyA"===t.code&&t.ctrlKey){let e=wearfits.getAllMaterials();wearfits.selected.materials||(wearfits.selected.materials=[]);let a=e.length==e.length&&e.every(function(e,t){return e===wearfits.selected.materials[t]});wearfits.selected.materials=a?[]:e,window.wf_editor&&wf_editor.updateInput(),t.preventDefault()}if("KeyZ"===t.code&&t.ctrlKey){let a=null,i=f;t.shiftKey?i<m&&(a=e.mementos[i+1])&&(wearfits.loadMaterialSetProp(wearfits.getObjectByName(a.objectName),a.materials),f=i+1):(i===m&&e.saveMemento(),(a=e.mementos[i-1])&&(wearfits.loadMaterialSetProp(wearfits.getObjectByName(a.objectName),a.materials),f=i-1)),e.updateInput(),t.preventDefault()}})}j.rel="stylesheet",j.href=wearfits.origin+"/static/css/color-picker.css",wearfits.canvas_container_inner.appendChild(j),e.setTransformTool=function(t,a){a=a||wearfits.selected.mesh,t?(e.tranformTool.enabled=!0,e.tranformTool.setMode(t),a&&e.tranformTool.attach(a)):(e.tranformTool.enabled=!1,e.tranformTool.detach()),wearfits.forceRenderWithTimeout("update_transform_tool")},e.initUI=function(){let t=document.getElementById("wf_editor_ui_container");if(t)t.append(a);else{if(!wearfits.canvas_container)throw"Wearfits editor: no canvas container found";{wearfits.canvas_container.append(a);let e=document.createElement("style");e.appendChild(document.createTextNode("#wearfits_canvas_container_outer { display: inline-block; width: calc(100% - 400px);}")),a.appendChild(e)}}s=document.getElementById("wf_editor_progress_info")||document.createElement("div"),wearfits.canvasResize(),wearfits.debugMode&&(e.advanceLevel=5);for(let e of document.getElementsByClassName("wf_editor_category")){let t=e.getAttribute("category");c[t]=e}for(let e of document.getElementsByClassName("wf_editor_category_button"))e.addEventListener("click",C.bind(null,e.getAttribute("category")),!1);R(),C(),e.updateInput()},e.insertToTextureList=function(e,t,a){let i=window["wf_editor_input_"+e],n=null;if(i){for(let e of i.childNodes)e.value==t&&(n=e);if(n||((n=document.createElement("option")).value=t,a||(n.text="LOAD ERROR"),i.appendChild(n)),a){if((a=a.replace(/%20/g," ")).includes(".")){let e=a.split(".");a=e[0].substring(0,14)+"."+e[1]}n.text=a}}},e.showModelInfo=function(){let e=wearfits.selected.object,t=(wearfits.selected.mesh,wearfits.selected.material,"");t+="ID: "+e.name+"<br>",t+="Created by: "+e.properties.createdBy+"<br>",t+="Creation date: "+F(e.properties.created)+"<br>",t+="Modified by: "+e.properties.modifiedBy+"<br>",t+="Modify date: "+F(e.properties.modified)+"<br>",t+="Owner: "+e.properties.owner+"<br><br>";let a=e.material_sets.find(t=>t.name===e.preset)||{};t+="Material set name: "+a.name+"<br>",t+="Created by: "+a.createdBy+"<br>",t+="Creation date: "+F(a.created)+"<br>",t+="Modified by: "+a.modifiedBy+"<br>",t+="Modify date: "+F(a.modified)+"<br>",s.innerHTML=t},e.fill_measurement_columns=function(e){const t=e.getAttribute("measurement-prop"),a=wearfits.selected.object,i=wearfits.garmentProp[a.name].sizes,n=a.properties.custom,r=document.getElementById("wf_editor_measurement_fill_step").value;let o,s;for(let e=0;e<i.length;++e){const a=i[e],r=n.measurement[a][t];if(r){o=e,s=r;break}}if(s)for(let e=0;e<i.length;++e){const a=i[e],l=(e-o)*r;n.measurement[a][t]=s+l}X()},e.updateInput=function(){if(!p)return;let t=wearfits.selected.object||{},i=wearfits.selected.mesh,n=wearfits.selected.material,r=wearfits.selected.materials||[];wearfits.forceRenderWithTimeout("update_editor_panel");let o=window.wf_editor_selected_materials;if(o){o.innerHTML="";for(let e of r)o.innerHTML+=e.name+"<br>"}if(wearfits.outlinePass&&(wearfits.outlinePass.selectedObjects=t.meshes||[],wearfits.outlinePass.selectedMaterials=r),window.wf_editor_upload_scene_line.style.display=t.file?"flex":"",wearfits.objects[0]&&wearfits.objects[1]&&wearfits.objects[0].file&&wearfits.objects[1].file?window.wf_editor_upload_merged_scene_line.style.display="flex":window.wf_editor_upload_merged_scene_line.style.display="",wf_editor_selection_error_overlay.style.display="none",c[d].style.display="block",!wearfits.selected.object)return c[d].style.display="none",wf_editor_selection_error_overlay.style.display="block",void(wearfits.getAllMeshes().length?(wf_editor_no_object_selected_info.style.display="",wf_editor_no_object_loaded_info.style.display="none"):(wf_editor_no_object_selected_info.style.display="none",wf_editor_no_object_loaded_info.style.display=""));let s=[],l=[];for(let t of a.getElementsByClassName("wf_editor_level_3"))e.advanceLevel<3?l.push(t):s.push(t);for(let t of a.getElementsByClassName("wf_editor_level_5"))e.advanceLevel<5?l.push(t):s.push(t);for(let t of a.getElementsByClassName("wf_editor_level_10"))e.advanceLevel<10?l.push(t):s.push(t);for(let e of a.getElementsByClassName("api-forms"))t.file?l.push(e):s.push(e);switch(W().length?wf_editor_warnings_mode_button.innerHTML='Warnings <span style="color:#FF6600">&#9888;</span>':wf_editor_warnings_mode_button.innerHTML="Warnings",d){case"PRESETS":for(let e of document.getElementsByClassName("wf-editor-tile-material-image"))e.hiddenSrc&&(e.src=e.hiddenSrc,delete e.hiddenSrc);break;case"WARNINGS":const r=document.createElement("div"),o=W(parseInt(wf_editor_warning_maximum_texture_size.value));for(let e of o){if("texture"===e.type){const t=e.sizeX,a=e.sizeY,i=e.image,n=e.materials,o=e.filename.toLowerCase().endsWith("png")?"image/png":"image/jpeg";let s=[];for(let r of e.issues)if("oversized"===r)for(let e of[512,1024,2048,4096])(e<t||e<a)&&s.push(D(i,e,e,n,o,"Resize "+e));else"png"===r?s.push(D(i,t,a,n,"image/jpeg","Convert to jpg")):"solid_color"===r&&s.push(z(n,"Convert to solid color"));let l=document.createElement("div");l.classList.add("wf_editor_line"),l.innerHTML=e.filename,r.appendChild(l);let d=document.createElement("div");d.classList.add("wf_editor_line"),d.innerHTML='<img src="'+e.image.src+'" style="width:26px;height:26px;"> '+e.sizeX+" x "+e.sizeY+" ("+n.length+")",r.appendChild(d);for(let e of s)r.appendChild(e)}else if("info"===e.type)for(let t of e.values){const e=document.createElement("div");e.classList.add("wf_editor_line"),e.innerHTML=t,r.appendChild(e)}r.appendChild(document.createElement("hr"))}0===r.children.length&&(r.innerHTML="No warnings"),wf_editor_warnings.innerHTML="",wf_editor_warnings.appendChild(r);break;case"FITTING_ROOM":if(window.wf_editor_fitting_room_overlay.style.display="none",0===t.index){window.wf_editor_fitting_room_overlay.style.display="";break}U("wf_editor_input_custom_",t.properties.custom,["uvMapRealLength","strainMapIntensity","simulationLength","stretch","motion","avatarVersion","avatarPreset","minHeight","maxHeight","minChest","maxChest","gender","externalMapType","thick","newMaterialNaming","disableNonFittableSizes","strainMapOnAvatar","strainMapFromMeasurement","useShirt","useShorts","usePants","useShoes","avatarInputPropMode"]),window.wf_editor_strainMapGreenColorRatio.innerHTML=Math.round(1e3*wearfits.strainMapGreenColorRatio)/1e3,X();break;case"CAMERA":window.wf_editor_input_scene_lockedCamera.checked=wearfits.lockedCamera,window.wf_editor_input_scene_controlsType.value=wearfits.controlsType,window.wf_editor_remove_camera_prop_button.disabled=t.properties.camera?"":"none";for(let e of wearfits.definedCameraAttributes){let t=window["wf_editor_input_controls_"+e],a=wearfits.controls[e];if(a&&a.isVector3)for(let t of["x","y","z"])window["wf_editor_input_controls_"+e+"_"+t].value=a[t];else t&&("checkbox"==t.type?t.checked=a:t.value=isFinite(a)?a:3.15*Math.sign(a))}window.wf_editor_input_camera_position_x.value=wearfits.camera.position.x,window.wf_editor_input_camera_position_y.value=wearfits.camera.position.y,window.wf_editor_input_camera_position_z.value=wearfits.camera.position.z,window.wf_editor_input_camera_fov.value=wearfits.camera.fov;break;case"SCENE":U("wf_editor_input_scene_",wearfits,["globalAmbientLightIntensity","backgroundTextureColor","theme","sRGBMode","useBasicLighting","useIBL","enablePostprocessing","toneMapping","toneMappingExposure","rayTracingToneMapping","rayTracingToneMappingExposure","rayTracingToneMappingWhitePoint","useHybridRenderer","rayTracingUseGround","enablePostprocessing"]);for(let e in wearfits.envMapUrlList){let t=wearfits.envMapUrl,a=wearfits.envMapUrlList[e];Array.isArray(t)&&(t=t[0]),Array.isArray(a)&&(a=a[0]),t===a&&(window.wf_editor_env_map_select.value=e)}window.wf_editor_input_materialSet_useSceneProp.checked=t.material_set.useSceneProp,window.wf_editor_input_scene_rayTracingToneMappingWhitePoint.parentElement.style.display=3===wearfits.rayTracingToneMapping?"":"none";for(let e of a.getElementsByClassName("wf_editor_postprocess"))e.style.display=wearfits.enablePostprocessing?"":"none";if(wearfits.enablePostprocessing){window.wf_editor_input_postprocess_bloomPass.checked=wearfits.bloomPass.enabled,window.wf_editor_input_postprocess_filmPass.checked=wearfits.filmPass.enabled,window.wf_editor_input_postprocess_vignettePass.checked=wearfits.vignettePass.enabled,window.wf_editor_input_postprocess_fxaaPass.checked=wearfits.fxaaPass.enabled,window.wf_editor_input_postprocess_smaaPass.checked=wearfits.smaaPass.enabled,window.wf_editor_input_postprocess_gammaCorrectionPass.checked=wearfits.gammaCorrectionPass.enabled,window.wf_editor_input_postprocess_outlinePass.checked=wearfits.outlinePass.enabled,window.wf_editor_input_postprocess_bokehPass.checked=wearfits.bokehPass.enabled,wearfits.bokehPass.enabled&&(window.wf_editor_bokehPass_focus.value=wearfits.bokehPass.uniforms.focus.value,window.wf_editor_bokehPass_aperture.value=1e5*wearfits.bokehPass.uniforms.aperture.value,window.wf_editor_bokehPass_maxblur.value=wearfits.bokehPass.uniforms.maxblur.value);for(let e of a.getElementsByClassName("postprocess-bokeh"))e.style.display=wearfits.bokehPass.enabled?"":"none"}break;case"TOOLS":U("wf_editor_input_editor_",e,["advanceLevel"]),U("wf_editor_input_scene_",wearfits,["applyMaterialsByIndex","useTileMaterials","forceOBJConversion"]);break;case"MESH":window.wf_editor_object_name.innerHTML=t.name,wearfits.getObjectFileSize(t).then(e=>{const t=Math.round(e/1048576*10)/10;window.wf_editor_object_filesize.innerHTML=t+" MB"}),window.wf_editor_input_object_protected.checked=!!t.protected,window.wf_editor_input_object_cacheNonce.value=t.cacheNonce||0,window.wf_editor_input_mesh_disableZoomRegion.checked=!!i.disableZoomRegion,window.wf_editor_input_mesh_position_x.value=i.position.x,window.wf_editor_input_mesh_position_y.value=i.position.y,window.wf_editor_input_mesh_position_z.value=i.position.z,window.wf_editor_input_mesh_rotation_x.value=THREE.Math.radToDeg(i.rotation.x),window.wf_editor_input_mesh_rotation_y.value=THREE.Math.radToDeg(i.rotation.y),window.wf_editor_input_mesh_rotation_z.value=THREE.Math.radToDeg(i.rotation.z),window.wf_editor_input_mesh_scale.value=i.scale.x,window.wf_editor_input_mesh_scale_x.value=i.scale.x,window.wf_editor_input_mesh_scale_y.value=i.scale.y,window.wf_editor_input_mesh_scale_z.value=i.scale.z;const c=e.advanceLevel>5||i.scale.x!==i.scale.y||i.scale.x!==i.scale.z;window.wf_editor_extended_scale.style.display=c?"":"none",window.wf_editor_mesh_name.innerHTML=i.name,window.wf_editor_mesh_vertices.innerHTML=wearfits.getMeshTriangles(i).toLocaleString("pl")+" / "+wearfits.getSceneTriangles().toLocaleString("pl"),window.wf_editor_mesh_dimensions.innerHTML=function(e){try{let t=new THREE.Box3;for(let a of e.meshes)t.expandByObject(a);let a=new THREE.Vector3;t.getSize(a);let i=[];for(let e of a.toArray())e=(e*=100).toFixed(2),i.push(e);return i.join(" / ")}catch(e){return"error"}}(t),window.wf_editor_selected_points_distance.innerHTML=Math.round(1e3*e.editTools.measurementPoint1.position.distanceTo(e.editTools.measurementPoint2.position))/1e3+"m",window.wf_editor_selected_point_position.innerHTML="( "+e.editTools.measurementPoint1.position.toArray().map(e=>e.toFixed(3)).join(", ")+" )";let f=t.properties.materialsData[n.name]||{};window.wf_editor_input_materialsData_uvIndex.value=f.uvIndex||"",window.wf_editor_input_materialsData_bakeTextureSize.value=f.bakeTextureSize||null;break;case"AR":window.wf_editor_input_object_excludeAR.checked=!!t.excludeAR,window.wf_editor_input_object_verticalAR.checked=!!t.verticalAR,window.wf_editor_input_object_resizableAR.checked=!!t.resizableAR,window.wf_editor_input_object_protectedAR.checked=!!t.protectedAR,window.wf_editor_input_object_noARPopup.checked=!!t.noARPopup,window.wf_editor_input_object_customARTitle.value=t.customARTitle||"",window.wf_editor_input_object_customARLink.value=t.customARLink||"";break;case"MATERIALS":if(!n)return;let m=["MeshStandardMaterial","MeshPhysicalMaterial","StandardNodeMaterial"].includes(n.type),p="StandardNodeMaterial"===n.type;for(let e of wearfits.definedMaps)n[e]&&"envMap"!==e&&(p=!0);for(let e of a.getElementsByClassName("wf_standard"))m?s.push(e):l.push(e);for(let e of a.getElementsByClassName("wf_physical"))"MeshPhysicalMaterial"!==n.type?l.push(e):s.push(e);for(let e of a.getElementsByClassName("wf_phong"))"MeshPhongMaterial"!==n.type?l.push(e):s.push(e);for(let e of a.getElementsByClassName("wf_fresnel"))n.isFresnel?s.push(e):l.push(e);for(let e of a.getElementsByClassName("wf_strain"))n.isStrain?s.push(e):l.push(e);for(let e of a.getElementsByClassName("wf_map_properties"))p?s.push(e):l.push(e);for(let e of a.getElementsByClassName("wf_editor_transparency_options"))n.transparent?s.push(e):l.push(e);for(let e of a.getElementsByClassName("wf_editor_fitting_room_options"))wearfits.modules.fitting_room?s.push(e):l.push(e);for(let e of s)e.style.display="";for(let e of l)e.style.display="none";s=[],l=[],n.map&&n.map.hasAlphaPixels&&(window.wf_editor_transparent_switch.style.display=""),n.alphaTest>0&&(window.wf_editor_alphaTest_switch.style.display=""),wearfits.objects.length>1&&(window.wf_editor_input_objectname.parentElement.style.display="");for(let e of wearfits.definedMaps)n[e]&&(window["wf_editor_input_"+e].parentElement.parentElement.style.display="");n.uv_scale_x!==n.uv_scale_y&&(window.wf_editor_input_uv_scale_x.parentElement.style.display=""),n.emissive&&0!=n.emissive.r&&0!=n.emissive.g&&0!=n.emissive.b&&(window.wf_editor_input_emissive.parentElement.style.display=""),n.normalScale&&(window.wf_editor_input_normalIntensity.style.display=n.normalMap?"":"none"),n.visible||(window.wf_editor_input_visible.parentElement.parentElement.style.display=""),n.wireframe&&(window.wf_editor_input_wireframe.parentElement.parentElement.style.display=""),n.vertexColors&&(window.wf_editor_input_vertexColors.parentElement.parentElement.style.display=""),n.isUnifiedUV&&(window.wf_editor_input_isUnifiedUV.parentElement.parentElement.style.display=""),"MeshStandardMaterial"!==n.type&&(window.wf_editor_input_type.parentElement.style.display=""),n.colorAdd&&(n.colorAdd.r||n.colorAdd.g||n.colorAdd.b)&&(window.wf_editor_input_colorAdd.parentElement.style.display=""),2!==n.side&&(window.wf_editor_input_side.parentElement.style.display=""),n.flatShading&&(window.wf_editor_flatShading_switch.style.display=""),n.depthWrite||(window.wf_editor_depthWrite_switch.style.display=""),window.wf_editor_input_aoMapIntensity.style.display=n.aoMap?"":"none",window.wf_editor_input_objectname.innerHTML="";for(let e=0;e<wearfits.objects.length;++e){const t=wearfits.objects[e];if(!t)continue;const a=document.createElement("option");a.value=t.name,a.innerHTML=e+". "+t.name,window.wf_editor_input_objectname.append(a)}window.wf_editor_input_objectname.value=t.name,window.wf_editor_input_meshname.innerHTML="";for(let e=0;e<t.meshes.length;++e){let a=document.createElement("option");a.value=t.meshes[e].name,a.innerHTML=e+". "+t.meshes[e].name,window.wf_editor_input_meshname.append(a)}window.wf_editor_input_meshname.value=i.name,window.wf_editor_input_materialname.innerHTML="";let u=new Set;for(let e=0;e<t.meshes.length;++e){let a=t.meshes[e];for(let e=0;e<a.material.length;++e)u.add(a.material[e].name)}for(let e of u){let t=document.createElement("option");t.value=e,t.innerHTML=e,window.wf_editor_input_materialname.append(t)}window.wf_editor_input_materialname.value=n.name,U("wf_editor_input_",n,wearfits.definedMaterialAttributes),U("wf_editor_input_",n,["wireframe","vertexColors","visible"]),n.normalScale&&(window.wf_editor_input_normalIntensity.value=n.normalScale.x),window.wf_editor_input_type.value=n.isFresnel?"MeshFresnelMaterial":n.type,window.wf_editor_input_preset.value=t.preset;for(let t of wearfits.definedMaps){let a=window["wf_editor_input_"+t],i=window["wf_editor_preview_image_"+t],r=document.querySelector("div.wf_editor_remove_map_button[mapType="+t+"]"),o=document.querySelector("div.wf_editor_edit_map_button[mapType="+t+"]"),s=n[t],l=wearfits.getMapUrl(s),d=wearfits.getMapFilename(s);a&&(s?l||d?(e.insertToTextureList(t,l,d),a.value=l):(e.insertToTextureList(t,"MISSING TEXTURE","MISSING TEXTURE"),a.value="MISSING TEXTURE"):a.value=""),r&&(r.style.display=s?"block":""),o&&(o.style.display=s?"block":""),i&&(i.src=l||"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="),s&&(window["wf_editor_input_"+t+"_sRGBEncoding"].checked=s.encoding===THREE.sRGBEncoding,window["wf_editor_input_"+t+"_flipY"].checked=s.flipY)}if(p&&(window.wf_editor_input_uv_scale.value=n.uv_scale_x,window.wf_editor_input_uv_scale_x.value=n.uv_scale_x,window.wf_editor_input_uv_scale_y.value=n.uv_scale_y,window.wf_editor_input_uv_offset_x.value=n.uv_offset_x,window.wf_editor_input_uv_offset_y.value=n.uv_offset_y,window.wf_editor_input_uv_rotation.value=n.uv_rotation),window.preset_list_dropdown&&(window.preset_list_dropdown.innerHTML="",t.material_sets))for(let e of t.material_sets){let t=document.createElement("OPTION");t.value=e.name,window.preset_list_dropdown.append(t)}window.wf_editor_preset_list.value=n.tile_material_name,window.wf_editor_input_useTileMaterials.checked=n.useTileMaterials,t.material_set&&(window.wf_editor_input_materialSet_visible.checked=t.material_set.visible)}for(let e of s)e.style.display="";for(let e of l)e.style.display="none"},e.updateInputThrottled=function(){v||(v=!0,setTimeout(()=>{v=!1,e.updateInput()},20))},e.updateAttribute=function(t){if(!wearfits.selected.material)return void wearfits.showToast("No selected material!");if(wearfits.forceRenderWithTimeout("update_material_attribute"),!t.id.startsWith("wf_editor_input"))return;let a=wearfits.selected.object,i=wearfits.selected.mesh,n=wearfits.selected.material,r=[n];wearfits.selected.materials&&wearfits.selected.materials.length&&(r=wearfits.selected.materials);let o=t.id.substring(16),s=o.split("_"),l=t.value;"checkbox"===t.type&&(l=t.checked),wearfits.useHybridRenderer||(wearfits.sceneChanged=!0);let d=e.mementos[f-1];if(d&&d.attr===o&&d.objectName===a.name&&d.materialName===n.name||e.saveMemento(o),"name"!==s[0])if("preset"!==s[0])if("mesh"===s[0]){let t=e.transformWholeObject?a.meshes:[i];wearfits.definedMeshAttributes.includes(s[1])&&(i[s[1]]=l);for(let e of t)if("scale"===s[1]){const t=s[2];if(t){let a=e.scale[t],i=parseFloat(l);e.scale[t]=i;let n=i/a;e.position[t]*=n}else{let t=e.scale.x,a=parseFloat(l);e.scale.set(a,a,a);let i=a/t;e.position.x*=i,e.position.y*=i,e.position.z*=i}wearfits.updateCameraBoundingBox()}else"position"===s[1]?(e.position[s[2]]=parseFloat(l),wearfits.updateCameraBoundingBox()):"rotation"===s[1]&&(e.rotation[s[2]]=THREE.Math.degToRad(parseFloat(l)),wearfits.updateCameraBoundingBox())}else if("editor"===s[0])e[s[1]]=N(l);else if("scene"===s[0])wearfits[s[1]]=N(l);else if("postprocess"===s[0])wearfits[s[1]].enabled=l;else if("controls"===s[0])s.length<=2?wearfits.controls[s[1]]=N(l):wearfits.controls[s[1]][s[2]]=parseFloat(l);else if("camera"===s[0])s.length<=2?(wearfits.camera[s[1]]=N(l),wearfits.camera.updateProjectionMatrix()):wearfits.camera[s[1]][s[2]]=N(l);else if("object"===s[0])a[s[1]]=l;else if("custom"===s[0]){let e=a.properties.custom;if(4===s.length){let t=s[2],a=s[3];e.measurement||(e.measurement={}),e.measurement[t]||(e.measurement[t]={}),e.measurement[t][a]=N(l)}else e[s[1]]=N(l);if("uvMapRealLength"===s[1]||"strainMapIntensity"===s[1]){window.wearfits_toggle_strain_map_button&&(window.wearfits_toggle_strain_map_button.style.display="flex");for(let t of wearfits.garments)wearfits.computeStrainMap(t,e.uvMapRealLength,e.strainMapIntensity)}if("strainMapOnAvatar"===s[1]&&(window.wearfits_toggle_strain_map_button&&(window.wearfits_toggle_strain_map_button.style.display="flex"),wearfits.initFakeStrainMaterialAvatar(wearfits.garment)),"strainMapFromMeasurement"===s[1]){window.wearfits_toggle_strain_map_button&&(window.wearfits_toggle_strain_map_button.style.display="flex"),wearfits.initFakeStrainMaterialGarment(wearfits.garment);for(let t of wearfits.garments)wearfits.computeStrainMap(t,e.uvMapRealLength,e.strainMapIntensity)}}else if("materialsData"===s[0]){let e=a.properties.materialsData;for(let t of r)e[t.name]||(e[t.name]={}),e[t.name][s[1]]=l}else if("materialSet"===s[0]){a.material_set[s[1]]=l}else for(let i=0;i<r.length;++i){let n=r[i];if(n.needsUpdate=!0,"type"===s[0]){let e=window.wf_editor_input_type.options[wf_editor_input_type.selectedIndex].text,t=wearfits.convertMaterial(n,e);r[i]=t,wearfits.selected.material===n&&(wearfits.selected.material=t);for(let e of a.meshes)for(let a=0;a<e.material.length;++a)e.material[a].name===n.name&&(e.material[a]=t);continue}if(1===s.length&&s[0].toLowerCase().endsWith("map")){const t=s[0];e.caman&&e.edit_matType===t&&Y(),wearfits.loadTexture(n,t,l).then(a=>{"map"===t&&(wearfits.setTransparentAuto(n,a),e.updateInput())});continue}if(2===s.length&&s[0].toLowerCase().endsWith("map")){if(n[s[0]].needsUpdate=!0,"sRGBEncoding"===s[1]){n[s[0]].encoding=l?THREE.sRGBEncoding:THREE.LinearEncoding;continue}if("flipY"===s[1]){n[s[0]].flipY=l;continue}}if("uv"===s[0]){"uv_scale"===o?(n.uv_scale_x=parseFloat(l),n.uv_scale_y=parseFloat(l),n.uv_scale=parseFloat(l)):n[o]=parseFloat(l);continue}if("normalIntensity"===s[0]){n.normalScale.x=parseFloat(l),n.normalScale.y=parseFloat(l);continue}"transparent"===s[0]&&!1===l&&(n.opacity=1);let d=n,c=0;for(;c<s.length-1;++c){if(!d[s[c]])return void console.log("Wearfits editor: updateAttribute undefined prop: "+s);d=d[s[c]]}if(t.classList.contains("hex_color_input")){let e=B(l);const t=d[s[c]];t?(t.r=e.r,t.g=e.g,t.b=e.b):console.log("Wearfits editor: updateAttribute undefined hex prop: "+s)}else d[s[c]]=N(l);if("strainMapIntensity"===s[0]){const e=a.properties.custom;wearfits.computeStrainMap(wearfits.selected.object,e.uvMapRealLength,e.strainMapIntensity)}}else a.preset=l},e.saveMemento=function(t){if(!e.enableUndoHistory)return;t=t||Math.random();let a=wearfits.selected.object,i=wearfits.selected.material;a&&i&&(e.mementos[f+1]=null,e.mementos[f]={attr:t,objectName:a.name,materialName:i.name,materials:wearfits.getMaterialSet(a)},m=f+=1)},e.initImageEditor=function(t,a){if(e.caman){if(t===e.edit_material&&a===e.edit_matType)return void C("IMAGE");if(!confirm("Unsaved image changes. continue?"))return;e.restoreOriginalImage()}const i=t[a];if(!i)return void console.log("Wearfits editor: initImageEditor texture is missing");const n=i.image,r=document.createElement("canvas");r.id="wf_editor_edit_canvas",r.setAttribute("data-caman-hidpi-disabled","1");const o=n.naturalWidth||n.width,s=n.naturalHeight||n.height;(o>=4e3||s>=4e3)&&alert(`Consider resizing image to 2048x2048 (${o}x${s})`),e.caman=Caman(r,n.src);const l=document.createElement("canvas");l.width=o,l.height=s;const d=l.getContext("2d");d.drawImage(n,0,0);const c=new THREE.CanvasTexture(l);c.encoding=wearfits.sRGBMode?THREE.sRGBEncoding:THREE.LinearEncoding,c.wrapS=c.wrapT=THREE.RepeatWrapping,e.edit_canvas=r,e.edit_texture_canvas=l,e.edit_texture_context=d,e.edit_original_texture=i,e.edit_texture=c,e.edit_material=t,e.edit_matType=a,t[a]=c,window.wf_editor_edit_canvas_container.innerHTML="",window.wf_editor_edit_canvas_container.appendChild(r),window.wf_editor_image_mode_button.style.display="inline-block",C("IMAGE"),e.resetImageFilters(!1)},e.updateImageFilters=function(){if(e.updatingFilters)e.updateFiltersThrottle=!0;else{e.updatingFilters=!0,e.updateFiltersThrottle=!1,e.edit_canvas.style.opacity=0,e.caman.revert(!1);for(let t of y){const a=document.getElementById("wf_editor_image_filter_value_"+t),i=parseFloat(a.value);i&&6600!==i?(a.style.backgroundColor="#FFDDDD",e.caman[t](i)):a.style.backgroundColor=""}e.caman.render(()=>{e.edit_texture_context.drawImage(e.edit_canvas,0,0),e.edit_texture.needsUpdate=!0,e.edit_canvas.style.opacity=1,wearfits.forceRenderWithTimeout(),e.updatingFilters=!1,e.updateFiltersThrottle&&setTimeout(e.updateImageFilters,300)})}},e.resetImageFilter=function(t,a=!0){const i=document.getElementById("wf_editor_image_filter_slider_"+t),n=document.getElementById("wf_editor_image_filter_value_"+t);i.value=0,n.value=0,"whiteBalance"===t&&(i.value=6600,n.value=6600),a&&e.updateImageFilters()},e.resetImageFilters=function(t=!0){for(let t of y)e.resetImageFilter(t,!1);t&&e.updateImageFilters()},e.restoreOriginalImage=function(t){e.edit_material&&e.edit_original_texture&&(e.edit_material[e.edit_matType]=e.edit_original_texture,e.edit_material.needsUpdate=!0),Y(),wearfits.forceRenderWithTimeout()},e.applyImageFilters=async function(t){const a=await new Promise(function(t,a){e.edit_texture_canvas.toBlob(e=>{t(e)},"image/jpeg",.9)}),i=new File([a],"computed_image.jpg");await wearfits.loadTexturesToSelectedMaterial([i],e.edit_matType,[e.edit_material],!0),Y(),wearfits.forceRenderWithTimeout()},e.getMaterialDataByIndexOrName=function(e){if(!wearfits.selected.mesh)return console.error("Object is not selected"),null;let t,a;if("string"==typeof e||e instanceof String)for(let i=0;i<wearfits.selected.mesh.material.length;++i)wearfits.selected.mesh.material[i].name===e&&(a=wearfits.selected.mesh.material[i],t=i);else a=wearfits.selected.mesh.material[e],t=e;return a?wearfits.getMaterialData(a):(console.error("Material does not exist: "+e),null)},e.removeAllMaterialsAtServer=async function(e="default"){let t=new FormData;t.append("object_name",wearfits.selected.object.name),t.append("preset",e),await G(t),s.innerHTML="REMOVE ALL FINISHED",wearfits.triggerEvent("upload_material_finish",wearfits.selected.object)},e.uploadAllMaterialsAtServer=async function(t=null,a="default",i=!0,n=!0,r=(e=>{s.innerHTML=e})){if(r("Uploading materials..."),t=t||wearfits.selected.object,e.caman){if(!confirm("Unsaved image editor, continue without saving?"))return void r("Aborted materials upload");e.restoreOriginalImage()}t.preset=a,t.presetHash=wearfits.getObjectMaterialsHash(t);let o=wearfits.getMaterialSet(t),l=new FormData;if(l.append("object_name",t.name),l.append("preset",a),l.append("material_set",JSON.stringify(o,null,2)),n){let e=await wearfits.urlToBlobFile(wearfits.getScreenshot(512,512),"preview.jpg");l.append("preview_image",e)}await G(l,r),i&&(r("Uploading textures..."),await wearfits.uploadTexturesAtServer(t)),r("Upload materials OK"),wearfits.triggerEvent("upload_material_finish",t)},e.uploadSceneMaterialsAtServer=async function(t=null,a="default",i=!0,n=!0,r=(e=>{s.innerHTML=e})){if(r("Uploading materials..."),e.caman){if(!confirm("Unsaved image editor, continue without saving?"))return void r("Aborted materials upload");e.restoreOriginalImage()}let o=wearfits.getMaterialSet(null),l=new FormData;if(l.append("object_name",t.name),l.append("preset",a),l.append("material_set",JSON.stringify(o,null,2)),n){let e=await wearfits.urlToBlobFile(wearfits.getScreenshot(512,512),"preview.jpg");l.append("preview_image",e)}await G(l,r),i&&(r("Uploading textures..."),await wearfits.uploadTexturesAtServer()),r("Upload materials OK")},e.uploadTileMaterialAtServer=async function(t,a=!0){let i=wearfits.selected.material.name,n=await wearfits.urlToBlobFile(wearfits.getMaterialPreview(wearfits.selected.material),t+".jpg"),r=new FormData;if(r.append("name",t),r.append("data",JSON.stringify(e.getMaterialDataByIndexOrName(i),null,2)),r.append("preview_image",n),await K(r),a){s.innerHTML="Uploading textures...";try{await wearfits.uploadTexturesAtServer(wearfits.selected.object,i)}catch(e){return void(s.innerHTML+=", TEXTURES_ERROR")}s.innerHTML+=", TEXTURES_OK"}s.innerHTML="UPLOAD FINISHED"},e.removeTileMaterialAtServer=async function(e,t=!0){let a=new FormData;a.append("name",e),await K(a),s.innerHTML="REMOVE FINISHED"},e.updateMeshPropAndUpload=async function(t=null,a=(e=>{s.innerHTML=e})){(t=t||wearfits.selected.object).properties.meshes=wearfits.getMeshesProperties(t,t.isConvertedToObj),await e.uploadObjectProperties(t,a)},e.updateCameraPropAndUpload=async function(t=null,a=!1){(t=t||wearfits.selected.object).properties.camera=wearfits.getCameraProperties(),a&&(t.properties.camera=null),await e.uploadObjectProperties(t)},e.uploadObjectProperties=async function(t=null,a=(e=>{s.innerHTML=e}),i=!1){return t=t||wearfits.selected.object,new Promise(function(n,r){let o=wearfits.getObjectProperties(t),s=new FormData;s.append("object_name",t.name),s.append("data",JSON.stringify(o,null,2)),s.append("force",i?1:0);let l=new XMLHttpRequest;l.onload=(async()=>{if(l.status>=200&&l.status<300){const e=JSON.parse(l.responseText);t.properties.modified=e.modified,a("Uploading mesh properties OK"),n()}else if(401==l.status)a("Uploading mesh properties UNAUTHORIZED"),r();else if(l.response.includes("outdated_working_copy"))if(confirm("Your working copy of object properties is older than server one. Please refresh this page or continue using your outdated version?"))try{await e.uploadObjectProperties(t,a,!0),n()}catch(e){r()}else a("Uploading mesh properties FAILED. Outdated properties"),r();else a("Uploading mesh properties FAILED"),r()}),l.open("POST",wearfits.origin+"/api/set_object_properties",!0),l.send(s),a("Uploading mesh properties...")})},e.uploadMesh=async function(e=null,t=(e=>{s.innerHTML=e})){if(!(e=e||wearfits.selected.object).file)throw console.error("Only local files can be uploaded"),"Only local files can be uploaded";if(e.needsConvert||wearfits.forceOBJConversion){t("Converting to obj ...");let a={},i=1;for(let t of e.meshes)if(a[t.name]){let e=t.name+"_"+i;console.log("Renaming mesh "+t.name+" -> "+e),t.name=e,i+=1,a[e]=e}else a[t.name]=t.name;await new Promise(e=>setTimeout(e,30));const n=wearfits.getOBJ(e,!1);e.file=n,e.filename=n.name,e.name=n.name.split(".")[0],e.isConvertedToObj=!0}if(!e.file.name.toLowerCase().endsWith(".gz")){t("Compressing...");const a=await V(e.file);e.file=a,e.name=a.name.split(".")[0]}if(await wearfits.checkFileExists(wearfits.assets_path_url+"/objects/"+e.name+"/model.obj.gz")){if(console.log("Wearfits editor: mesh already exists at server: "+e.name+".obj"),t("Mesh already exists"),confirm("Mesh already exists at server, override current materials and properties?"))return;throw"aborted"}t("Uploading...");let a=new FormData;a.append("file",e.file);try{const t=await wearfits.request(wearfits.origin+"/api/upload_mesh","POST",a);e.name=t}catch(e){throw e.response}t("Upload mesh OK")},e.uploadMergedMesh=async function(e=(e=>{s.innerHTML=e})){let t={},a=1;for(let e of wearfits.objects)if(e&&e.mesh)for(let i of e.meshes)if(t[i.name]){let e=i.name+"_"+a;console.log("Renaming mesh "+i.name+" -> "+e),i.name=e,a+=1,t[e]=e}else t[i.name]=i.name;const i=wearfits.getOBJ(null,!1);e("Compressing...");const n=await V(i),r={filename:i.name,file:n,name:n.name.split(".")[0],properties:{}};if(await wearfits.checkFileExists(wearfits.assets_path_url+"/objects/"+r.name+"/model.obj.gz")){if(console.log("Wearfits editor: mesh already exists at server: "+r.name+".obj"),e("Mesh already exists"),confirm("Mesh already exists at server, override current materials and properties?"))return r;throw"aborted"}e("Uploading...");let o=new FormData;o.append("file",r.file);try{const e=await wearfits.request(wearfits.origin+"/api/upload_mesh","POST",o);r.name=e}catch(e){throw e.response}return e("Upload mesh OK"),r},e.upload_strain_map=async function(e,t,a=(e=>{s.innerHTML=e})){if(!e)return void console.error("No garment_name");if(!t)return void console.error("No file");a("Uploading ...");let i=new FormData;i.append("object_name",e);for(let e of t)i.append("files",e);try{const e=await wearfits.request(wearfits.origin+"/api/fitting_room/upload_strain_map","POST",i);console.log(e)}catch(e){throw a("Failed"),e.response}a("Upload strain map OK")},e.upload_ar_files=async function(e,t,a=(e=>{s.innerHTML=e})){if(!e)return void console.error("No object");if(!t)return void console.error("No files");a("Uploading ...");const i=new FormData;i.append("object_name",e.name),i.append("preset",e.preset);for(let e of t)i.append("files",e);try{const e=await wearfits.request(wearfits.origin+"/api/upload_ar_files","POST",i);console.log(e)}catch(e){throw a("Failed"),e.response}a("Upload AR files OK")},e.saveScene=async function(t,a=(e=>{s.innerHTML=e})){try{t=t||wearfits.selected.object||wearfits.object,C("MATERIALS"),await e.uploadMesh(t,a),await e.uploadAllMaterialsAtServer(t,"default",!0,!0,a),t.properties.meshes=wearfits.getMeshesProperties(t,t.isConvertedToObj),await e.uploadObjectProperties(t,a,!0)}catch(e){throw a(e),e}},e.saveMergedScene=async function(t=(e=>{s.innerHTML=e})){try{C("MATERIALS");const a=await e.uploadMergedMesh(t);await e.uploadSceneMaterialsAtServer(a,"default",!0,!0,t),await e.uploadObjectProperties(a,t,!0),window.location.href="/viewer?object="+a.name}catch(e){throw t(e),e}},e.bake_ao_map=function(){q(!0)},e.bake=function(){q(!1)},e.getBakeMaps=async function(e,t=!1,a=null){let i="?n="+Date.now(),n=[];if(wearfits.modules.fitting_room)t?"aomap"===e?wearfits.getAmbientMapsAndApply():wearfits.getBakeAndApply():"aomap"===e?(n=["/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_"+e+".jpg","/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_avatar_"+e+".jpg"],wearfits.avatar.prop&&wearfits.avatar.prop.input&&wearfits.avatar.prop.input.use_pants&&n.push("/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_avatar_pants_"+e+".jpg")):(n=["/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_"+e+"_"+wearfits.avatar.preset+"_"+wearfits.garment.preset+".jpg","/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_avatar_"+e+"_"+wearfits.avatar.preset+"_"+wearfits.garment.preset+".jpg"],wearfits.avatar.prop&&wearfits.avatar.prop.input&&wearfits.avatar.prop.input.use_pants&&n.push("/fr/cache/"+wearfits.garment.hash+"/"+wearfits.garment.id+"_avatar_pants_"+e+".jpg"));else if(a=a||wearfits.getSceneName(),document.getElementById("wf_editor_bake_selected_only").checked){n=["/tmp/"+[a,"default",e].join("_")+".jpg"]}else{let r={};for(let n of wearfits.objects)if(t&&"bake"===e&&n.preset.endsWith("_bake"))wearfits.showToast("Already applied: "+n.name);else for(let o of n.meshes)for(let s=0;s<o.material.length;++s){let l=o.material[s],d=wearfits.getUVIndex(n,l);if(d){let c="/tmp/"+[a,d,e].filter(e=>!!e).join("_")+".jpg";r[c]=c,t&&(wearfits.storeBlobTexture(c,null,!0),wearfits.getTexturePromise(c+i).then(t=>{"bake"===e?(n.preset.endsWith("_bake")||(n.preset=n.preset+"_bake",n.material_set.useSceneProp=!0,wearfits.setTheme("shadeless")),wearfits.applyBakedTextureToMaterial(o,s,t)):(l.aoMap=t,l.needsUpdate=!0,l.aoMapIntensity=1.5)}).catch(e=>{console.error("Texture does not exist: "+c)}))}}for(let e in r)n.push(e)}if(!t)for(let e of n)e+=i,console.log(e),wearfits.saveFile(e)},e.setEnvMap=function(t){t?(new THREE.TextureLoader).load(t,t=>{t.mapping=THREE.SphericalReflectionMapping,wearfits.selected.material.envMap=t,wearfits.selected.material.needsUpdate=!0,e.updateInput()}):(wearfits.selected.material.envMap=null,wearfits.selected.material.needsUpdate=!0,e.updateInput())},(document.attachEvent?"complete"===document.readyState:"loading"!==document.readyState)?ne():document.addEventListener("DOMContentLoaded",ne)}(this.wf_editor={});