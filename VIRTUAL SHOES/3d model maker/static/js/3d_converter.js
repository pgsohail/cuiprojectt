"use strict";var socket=null,current_task=null;async function get_task(e=null){let t=await wearfits.request("/photogrammetry/api/get_task/"+e,"GET");parse_task(JSON.parse(t))}async function get_queue_position(e=null){let t=await wearfits.request("/photogrammetry/api/get_queue_position/"+e,"GET");t=parseInt(t),current_task.process_queued&&!current_task.process_running&&(progress_info.innerHTML="In queue: "+t)}function copy_onclick(e){e.select(),document.execCommand("copy")}async function remove_task(){if(!confirm("Are you sure?"))return;const e=new FormData,t=current_task.id;e.append("id",t);try{await wearfits.request("/photogrammetry/api/remove_task","POST",e),show_upload_section(),console.log("Removed task "+t+": OK")}catch(e){console.log(e)}}async function retry_task(){const e=new FormData,t=current_task.id;e.append("id",t);try{await wearfits.request("/photogrammetry/api/retry_stage","POST",e),console.log("Retry task "+t+": OK")}catch(e){console.log(e)}}function update_progress_bar(e,t){if(progress_preprocessing.style.width="0%",progress_building.style.width="0%",progress_postprocessing.style.width="0%",progress_uploading.style.width="0%",e){switch(e){case"uploading":progress_postprocessing.style.width="10%";case"postprocessing":progress_building.style.width="70%";case"building":progress_preprocessing.style.width="10%"}switch(e){case"preprocessing":progress_preprocessing.style.width=t/100*10+"%";break;case"building":progress_building.style.width=t/100*70+"%";break;case"postprocessing":progress_postprocessing.style.width=t/100*10+"%";break;case"uploading":progress_uploading.style.width=t/100*10+"%"}}}function update_progress(){if(2===current_task.stage&&current_task.model_id)return void(window.location.href=wearfits.origin+"/object/"+current_task.model_id);progress_info.innerHTML=current_task.process_status,update_progress_bar(current_task.process_stage,current_task.process_progress),current_task.process_queued&&!current_task.process_running&&get_queue_position(current_task.id),window.retry_button.style.display=current_task.process_error?"":"none"}function show_upload_section(){upload_files_section.style.display="flex",progress_section.style.display="none",current_task=null}function show_progress_section(){upload_files_section.style.display="none",progress_section.style.display="flex"}function parse_task(e=null){current_task=e||current_task;let t=document.getElementById("preview_image");current_task.preview_image_url?t.src=current_task.preview_image_url:t.style.display="none",document.getElementById("photogrammetry_status_link").value=window.location.href,connect_websocket(),show_progress_section(),update_progress(current_task)}function connect_websocket(){if(e)e.emit("listen_task",current_task.id);else{var e=io({transports:["websocket"],upgrade:!1});e.on("connect",function(){console.log("Websocket connected!"),e.emit("listen_task",current_task.id)}),e.on("disconnect",function(){console.log("Websocket disconnected!")}),e.on("update_photogrammetry_task",function(e){current_task.id===e.id&&(current_task=e,update_progress())})}}wf_editor.init_ui=!1;let id=new URL(window.location.href).searchParams.get("id");async function check_zip_content(e){const t=new JSZip;await t.loadAsync(e);let o=!1,s=!1;for(let e in t.files){let t=e.toLowerCase();/\.obj$|\.glb$|\.stl$|\.gltf$|\.fbx$/.test(t)&&(o=!0),/\.jpg$|\.jpeg$|\.png$|\.heic$|\.heif$/.test(t)&&(s=!0)}return[o,s]}async function upload_3d_model_or_photos(e,t=(()=>{})){t("Checking content...");try{let o=!1,s=!1;if(1===e.length){const t=e[0].name.toLowerCase();t.endsWith(".zip")?[o,s]=await check_zip_content(e[0]):/\.tar$|\.mp4$|\.mov$/.test(t)&&(s=!0)}for(let t of e){const e=t.name.toLowerCase();/\.obj$|\.glb$|\.stl$|\.gltf$|\.fbx$/.test(e)&&(o=!0),/\.jpg$|\.jpeg$|\.png$|\.heic$|\.heif$/.test(e)&&(s=!0)}if(o)if(console.log("3D model detected"),t("3D model detected. Preparing to upload..."),await wearfits.loadByFiles(e),wearfits.object.mesh){for(let e of wearfits.object.meshes)await wearfits.waitForTextureLoad(e);await wf_editor.saveScene(wearfits.object,t),t("Uploaded OK"),wearfits.getGLTF(),wearfits.getUSDZ(),window.location.href=wearfits.origin+"/object/"+wearfits.object.name}else t("Failed parse 3D model file");else if(s){console.log("photos detected"),t("photos detected");const o=await upload_photos_or_zip_file(e,e=>{window.upload_progress.innerHTML=e},!0);window.history.pushState(o.id,"","?id="+o.id),parse_task(o)}else console.log("Invalid files: no 3D model or photos"),t("Invalid files: no 3D model or photos")}catch(e){console.log(e),t(e)}}function onDocumentLoad(){const e=document.getElementById("input_files_area");e.addEventListener("click",e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.onchange=(async()=>{await upload_3d_model_or_photos(t.files,e=>{window.upload_progress.innerHTML=e},!0)}),t.click()}),e.addEventListener("dragover",t=>{t.preventDefault(),e.style.backgroundColor="green"}),e.addEventListener("drop",async t=>{t.preventDefault(),e.style.backgroundColor="lightgray";let o=await getAllFiles(t.dataTransfer.items);await upload_3d_model_or_photos(o,e=>{window.upload_progress.innerHTML=e},!0)}),document.addEventListener("dragover",e=>{e.preventDefault()}),document.addEventListener("dragenter",t=>{e.style.backgroundColor="gray"}),document.addEventListener("dragend",t=>{e.style.backgroundColor="lightgray"}),document.addEventListener("drop",t=>{t.preventDefault(),e.style.backgroundColor="lightgray"})}id&&get_task(id).catch(e=>{console.log(e),console.warn("Task does not exist: "+id)}),(document.attachEvent?"complete"===document.readyState:"loading"!==document.readyState)?setTimeout(onDocumentLoad,0):document.addEventListener("DOMContentLoaded",onDocumentLoad);